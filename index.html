<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Documentos Educativos</title>

    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.1/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.34.2/build/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Merriweather:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Merriweather', serif;
        }

        .card-3d {
            transform-style: preserve-3d;
            transition: transform 0.5s;
        }

        .card-3d:hover {
            transform: rotateY(5deg) rotateX(5deg);
        }

        .dark .card-3d:hover {
            transform: rotateY(2deg) rotateX(2deg);
        }

        /* Estilo para el scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #374151;
        }

        ::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">
    <div class="container mx-auto px-4 py-8 flex-grow">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-2">Generador de Documentos Educativos</h1>
            <p class="text-gray-400">Crea cuadros para diferentes áreas de estudio</p>
        </header>

        <main>
            <!-- Página de selección de asignatura -->
            <div id="subject-selection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg card-3d cursor-pointer subject-card"
                    data-subject="matematica">
                    <div class="text-center">
                        <div class="text-5xl mb-4 text-blue-400">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <h2 class="text-xl font-semibold mb-2">Matemática</h2>
                        <p class="text-gray-400 mb-4">Cuadros para planificación de matemática</p>
                        <button
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-300 start-btn">Comenzar</button>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl p-6 shadow-lg card-3d cursor-pointer subject-card"
                    data-subject="lenguaje">
                    <div class="text-center">
                        <div class="text-5xl mb-4 text-green-400">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <h2 class="text-xl font-semibold mb-2">Práctica del Lenguaje</h2>
                        <p class="text-gray-400 mb-4">Cuadros para planificación de lenguaje</p>
                        <button
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-300 start-btn">Comenzar</button>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl p-6 shadow-lg card-3d cursor-pointer subject-card"
                    data-subject="naturales">
                    <div class="text-center">
                        <div class="text-5xl mb-4 text-yellow-400">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <h2 class="text-xl font-semibold mb-2">Ciencias Naturales</h2>
                        <p class="text-gray-400 mb-4">Cuadros para planificación de ciencias naturales</p>
                        <button
                            class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition duration-300 start-btn">Comenzar</button>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl p-6 shadow-lg card-3d cursor-pointer subject-card"
                    data-subject="sociales">
                    <div class="text-center">
                        <div class="text-5xl mb-4 text-red-400">
                            <i class="fas fa-globe-americas"></i>
                        </div>
                        <h2 class="text-xl font-semibold mb-2">Ciencias Sociales</h2>
                        <p class="text-gray-400 mb-4">Cuadros para planificación de ciencias sociales</p>
                        <button
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-300 start-btn">Comenzar</button>
                    </div>
                </div>
            </div>

            <!-- Formulario para cada asignatura -->
            <div id="subject-form" class="hidden max-w-4xl mx-auto bg-gray-800 rounded-xl p-6 shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="form-title" class="text-2xl font-bold"></h2>
                    <button id="back-btn" class="text-gray-400 hover:text-white">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                </div>

                <form id="document-form" class="space-y-6">
                    <input type="hidden" id="subject-type" name="subject_type">

                    <!-- Campos comunes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- nombre -->
                        <div>
                            <label for="nombre" class="block text-sm font-medium mb-1">Nombre:</label>
                            <textarea id="nombre" name="nombre" rows="1"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white"></textarea>
                        </div>
                        <!-- curso -->
                        <div>
                            <label for="curso" class="block text-sm font-medium mb-1">Curso:</label>
                            <textarea id="curso" name="curso" rows="1"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white"></textarea>
                        </div>
                        <!-- escuela -->
                        <div>
                            <label for="escuela" class="block text-sm font-medium mb-1">Escuela:</label>
                            <textarea id="escuela" name="escuela" rows="1"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white"></textarea>
                        </div>
                        <!-- turno -->
                        <div>
                            <label for="turno" class="block text-sm font-medium mb-1">Turno:</label>
                            <textarea id="turno" name="turno" rows="1"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white"></textarea>
                        </div>
                        <!-- grado -->
                        <div>
                            <label for="grado" class="block text-sm font-medium mb-1">Grado:</label>
                            <textarea id="grado" name="grado" rows="1"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white"></textarea>
                        </div>
                        <!-- MO -->
                        <div>
                            <label for="mo" class="block text-sm font-medium mb-1">MO:</label>
                            <textarea id="mo" name="mo" rows="1"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white"></textarea>
                        </div>
                        <!-- Tema/s asignados por el MO para trabajar: -->
                        <div>
                            <label for="tema" class="block text-sm font-medium mb-1">Tema/s asignados por el MO:</label>
                            <textarea id="tema" name="tema" rows="1"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white"></textarea>
                        </div>
                    </div>

                    <!-- Campos específicos por asignatura -->
                    <div id="specific-fields" class="space-y-4">
                        <!-- Los campos específicos se cargarán dinámicamente según la asignatura -->
                    </div>

                    <div class="flex justify-between pt-4">
                        <button type="button" id="back-btn-form"
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition duration-300">
                            Volver
                        </button>
                        <button type="button" id="download-word"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition duration-300">
                            <i class="fas fa-file-word mr-2"></i> Descargar Word
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- <footer class="bg-gray-800 py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <div class="flex justify-center space-x-6">
                <a href="mailto:ramirodev7@gmail.com" class="text-gray-400 hover:text-white transition duration-300">
                    <i class="fas fa-envelope text-xl"></i>
                </a>
                <a href="https://ramirodev7.github.io/" target="_blank"
                    class="text-gray-400 hover:text-white transition duration-300">
                    <i class="fas fa-globe text-xl"></i>
                </a>
            </div>
        </div>
    </footer> -->

    <script>
        // Configuración de campos y títulos (sin cambios)
        const subjectFields = {
            matematica: [
                { id: 'objetivos', name: 'objetivos', label: 'Objetivos:', rows: 3 },
                { id: 'bloques', name: 'bloques', label: 'Bloques:', rows: 2 },
                { id: 'contenidos_generales', name: 'contenidos_generales', label: 'Contenidos Generales:', rows: 3 },
                { id: 'conceptos', name: 'conceptos', label: 'Conceptos:', rows: 3 },
                { id: 'modos_de_conocer', name: 'modos_de_conocer', label: 'Modos de Conocer:', rows: 3 },
                { id: 'indicadores_de_avance', name: 'indicadores_de_avance', label: 'Indicadores de Avance:', rows: 3 },
                { id: 'delimitacion_de_contenido', name: 'delimitacion_de_contenido', label: 'Delimitación de Contenido:', rows: 3 }
            ],
            lenguaje: [
                { id: 'objetivos', name: 'objetivos', label: 'Objetivos:', rows: 3 },
                { id: 'ambitos', name: 'ambitos', label: 'Ámbitos:', rows: 2 },
                { id: 'ejes', name: 'ejes', label: 'Ejes', rows: 2 },
                { id: 'contenidos', name: 'contenidos', label: 'Contenidos:', rows: 3 },
                { id: 'modos_de_conocer', name: 'modos_de_conocer', label: 'Modos de Conocer:', rows: 3 },
                { id: 'indicadores_de_avance', name: 'indicadores_de_avance', label: 'Indicadores de Avance:', rows: 3 },
                { id: 'delimitacion_de_contenido', name: 'delimitacion_de_contenido', label: 'Delimitación de Contenido:', rows: 3 }
            ],
            naturales: [
                { id: 'objetivos', name: 'objetivos', label: 'Objetivos:', rows: 3 },
                { id: 'objetivos_por_bloque', name: 'objetivos_por_bloque:', label: 'Objetivos por Bloque:', rows: 2 },
                { id: 'conceptos', name: 'conceptos', label: 'Conceptos:', rows: 3 },
                { id: 'modos_de_conocer', name: 'modos_de_conocer', label: 'Modos de Conocer:', rows: 3 },
                { id: 'indicadores_de_avance', name: 'indicadores_de_avance', label: 'Indicadores de Avance:', rows: 3 },
                { id: 'delimitacion_de_contenido', name: 'delimitacion_de_contenido', label: 'Delimitación de Contenido:', rows: 3 }
            ],
            sociales: [
                { id: 'objetivos', name: 'objetivos', label: 'Objetivos:', rows: 3 },
                { id: 'bloque', name: 'bloque', label: 'Bloque:', rows: 2 },
                { id: 'conceptos', name: 'conceptos', label: 'Conceptos:', rows: 3 },
                { id: 'modos_de_conocer', name: 'modos_de_conocer', label: 'Modos de Conocer:', rows: 3 },
                { id: 'indicadores_de_avance', name: 'indicadores_de_avance', label: 'Indicadores de Avance:', rows: 3 },
                { id: 'delimitacion_de_contenido', name: 'delimitacion_de_contenido', label: 'Delimitación de Contenido:', rows: 3 }
            ]
        };
        const subjectTitles = {
            matematica: 'Planificación de Matemática',
            lenguaje: 'Planificación de Práctica del Lenguaje',
            naturales: 'Planificación de Ciencias Naturales',
            sociales: 'Planificación de Ciencias Sociales'
        };

        // Mapeo de asignaturas a rutas de plantillas
        const templatePaths = {
            matematica: 'templates/Matemática.docx',
            lenguaje: 'templates/Prácticas del Lenguaje.docx',
            naturales: 'templates/Ciencias Naturales.docx',
            sociales: 'templates/Ciencias Sociales.docx'
        };

        // Elementos del DOM
        const subjectSelection = document.getElementById('subject-selection');
        const subjectForm = document.getElementById('subject-form');
        const formTitle = document.getElementById('form-title');
        const subjectTypeInput = document.getElementById('subject-type');
        const specificFieldsContainer = document.getElementById('specific-fields');
        const backBtn = document.getElementById('back-btn');
        const backBtnForm = document.getElementById('back-btn-form');
        const downloadWordBtn = document.getElementById('download-word');
        const form = document.getElementById('document-form');


        // **Lógica de Generación de Documentos**

        /**
         * Carga un archivo binario desde una URL.
         * @param {string} url - La URL del archivo de plantilla.
         * @returns {Promise<ArrayBuffer>} - El contenido del archivo como ArrayBuffer.
         */
        const loadFile = (url) => {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.responseType = 'arraybuffer';
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        resolve(xhr.response);
                    } else {
                        reject(new Error(`Error al cargar la plantilla: ${xhr.statusText}`));
                    }
                };
                xhr.onerror = () => reject(new Error('Error de red al cargar la plantilla.'));
                xhr.send();
            });
        };

        /**
         * Recoge los datos del formulario y los devuelve como un objeto.
         * @returns {Object} - Los datos del formulario.
         */
        const getFormData = () => {
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                // Reemplaza saltos de línea con etiquetas de Word para múltiples párrafos
                const processedValue = value.split('\n').map(line => line.trim()).filter(line => line).join('</w:t><w:br/><w:t>');
                data[key] = processedValue;
            }
            return data;
        };


        /**
         * Función principal para generar el documento .docx.
         */
        const generateDocument = async () => {
            const subject = subjectTypeInput.value;
            const templatePath = templatePaths[subject];

            if (!templatePath) {
                alert('Asignatura no válida.');
                return;
            }

            try {
                // 1. Cargar la plantilla .docx
                const content = await loadFile(templatePath);

                // 2. Inicializar PizZip y docxtemplater
                const zip = new PizZip(content);
                const doc = new docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true, // Permite saltos de línea con \n o \r\n
                });

                // 3. Recoger los datos del formulario
                const data = getFormData();

                // 4. Asignar los datos a la plantilla
                doc.setData(data);

                // 5. Renderizar el documento (reemplazar etiquetas)
                doc.render();

                // 6. Generar el archivo final como un Blob
                const out = doc.getZip().generate({
                    type: 'blob',
                    mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                });

                // 7. Descargar el archivo usando FileSaver.js
                saveAs(out, `${subjectTitles[subject]}.docx`);

            } catch (error) {
                console.error('Error al generar el documento:', error);
                alert('Ocurrió un error al generar el documento. Revisa la consola para más detalles.');
            }
        };


        // **Manejo de la Interfaz de Usuario (UI)**

        document.querySelectorAll('.subject-card .start-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation(); // Evita que el evento de clic se propague al div padre
                const subject = button.closest('.subject-card').dataset.subject;
                showSubjectForm(subject);
            });
        });

        backBtn.addEventListener('click', showSubjectSelection);
        backBtnForm.addEventListener('click', showSubjectSelection);
        downloadWordBtn.addEventListener('click', generateDocument);

        function showSubjectSelection() {
            subjectSelection.classList.remove('hidden');
            subjectForm.classList.add('hidden');
            form.reset(); // Limpia el formulario al volver
        }

        function showSubjectForm(subject) {
            form.reset();
            formTitle.textContent = subjectTitles[subject];
            subjectTypeInput.value = subject;
            specificFieldsContainer.innerHTML = '';

            const fields = subjectFields[subject];
            fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                // Corregimos los nombres de los campos para que coincidan con las plantillas
                const fieldName = field.id.replace(/-/g, '_');
                fieldDiv.innerHTML = `
                <label for="${field.id}" class="block text-sm font-medium mb-1">${field.label}</label>
                <textarea id="${field.id}" name="${fieldName}" rows="${field.rows}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white"></textarea>
            `;
                specificFieldsContainer.appendChild(fieldDiv);
            });

            subjectSelection.classList.add('hidden');
            subjectForm.classList.remove('hidden');
        }


        // He eliminado la función de capitalización automática, ya que puede ser molesta
        // para el usuario y es mejor dejar el formato a su criterio.
    </script>
</body>

</html>